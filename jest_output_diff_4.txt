  console.error
    --- MODULE LOADED: actions.staff.ts ---

      1 | 'use server'
    > 2 | console.error('--- MODULE LOADED: actions.staff.ts ---');
        |         ^
      3 |
      4 | import prisma from '@/lib/prisma';
      5 | import { AdminCreateSystemUserSchema, AdminUpdateSystemUserSchema } from './schemas';

      at Object.error (src/lib/actions.staff.ts:2:9)
      at Object.<anonymous> (src/lib/actions.staff.test.ts:69:23)

  console.error
    [DEBUG TEST] session: true true

      115 | export async function adminUpdateSystemUser(prevState: any, formData: FormData) {
      116 |     const session = await auth();
    > 117 |     console.error('[DEBUG TEST] session:', !!session, !!session?.user?.email);
          |             ^
      118 |     if (!session?.user?.email) return { message: 'Unauthorized' };
      119 |     const userRole = (session.user as any).role;
      120 |     if (userRole !== 'ADMIN') {

      at error (src/lib/actions.staff.ts:117:13)
      at Object.<anonymous> (src/lib/actions.staff.test.ts:328:24)

  console.error
    [DEBUG TEST] dataToValidate: {"id":"user-sys-123","name":"New Name","email":"new@test.com","role":"NEW-ROLE","active":true,"rut":"11111111-1"}

      140 |     };
      141 |
    > 142 |     console.error('[DEBUG TEST] dataToValidate:', JSON.stringify(dataToValidate));
          |             ^
      143 |     const validation = AdminUpdateSystemUserSchema.safeParse(dataToValidate);
      144 |     if (!validation.success) {
      145 |         console.error('[DEBUG TEST] validation failed:', JSON.stringify(validation.error.format()));

      at error (src/lib/actions.staff.ts:142:13)
      at Object.<anonymous> (src/lib/actions.staff.test.ts:328:24)

  console.error
    [DEBUG TEST] validation passed

      146 |         return { message: 'Datos inválidos: ' + validation.error.issues.map(e => e.message).join(', ') };
      147 |     }
    > 148 |     console.error('[DEBUG TEST] validation passed');
          |             ^
      149 |
      150 |     const vData = validation.data;
      151 |     const { id: vId, name: vName, email: vEmail, role: vRole, active: vActive, rut: vRut, region: vRegion, commune: vCommune, address: vAddress, password: vPassword } = vData;

      at error (src/lib/actions.staff.ts:148:13)
      at Object.<anonymous> (src/lib/actions.staff.test.ts:328:24)

  console.error
    [adminUpdateSystemUser] Error: TypeError: rolePermissions is not iterable
        at rolePermissions (/Users/max/Documents/Sistemas Hospital/Broncopulmonar/Sistema_Gestion_Broncopulmonar/src/lib/actions.staff.ts:238:32)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at Object.<anonymous> (/Users/max/Documents/Sistemas Hospital/Broncopulmonar/Sistema_Gestion_Broncopulmonar/src/lib/actions.staff.test.ts:328:24)

      261 |         return { message: 'Success' };
      262 |     } catch (e: any) {
    > 263 |         console.error('[adminUpdateSystemUser] Error:', e);
          |                 ^
      264 |         return { message: e.message || 'Error al actualizar usuario' };
      265 |     }
      266 | }

      at error (src/lib/actions.staff.ts:263:17)
      at Object.<anonymous> (src/lib/actions.staff.test.ts:328:24)

  console.error
    RESULT OF adminUpdateSystemUser: {"message":"rolePermissions is not iterable"}

      327 |
      328 |         const result = await adminUpdateSystemUser(null, formData);
    > 329 |         console.error('RESULT OF adminUpdateSystemUser:', JSON.stringify(result));
          |                 ^
      330 |         expect(result.message).toBe('Success');
      331 |
      332 |         expect(logAction).toHaveBeenCalledWith(

      at Object.error (src/lib/actions.staff.test.ts:329:17)

FAIL src/lib/actions.staff.test.ts
  Staff Actions
    ✕ logs diff on user update (561 ms)
    ○ skipped seeds permissions on create
    ○ skipped updates permissions on role change
    ○ skipped does NOT update permissions if role is same
    ○ skipped deletes user successfully
    ○ skipped prevents self-deletion
    Permission Management
      ○ skipped updates role permissions for all users in role
      ○ skipped seeds default permissions
      ○ skipped gets my permissions
      ○ skipped returns empty permissions if not logged in
    Validation Errors
      ○ skipped create fails with invalid RUT

  ● Staff Actions › logs diff on user update

    expect(received).toBe(expected) // Object.is equality

    Expected: "Success"
    Received: "rolePermissions is not iterable"

      328 |         const result = await adminUpdateSystemUser(null, formData);
      329 |         console.error('RESULT OF adminUpdateSystemUser:', JSON.stringify(result));
    > 330 |         expect(result.message).toBe('Success');
          |                                ^
      331 |
      332 |         expect(logAction).toHaveBeenCalledWith(
      333 |             'USER_UPDATED',

      at Object.toBe (src/lib/actions.staff.test.ts:330:32)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 10 skipped, 11 total
Snapshots:   0 total
Time:        5.146 s
Ran all test suites matching src/lib/actions.staff.test.ts with tests matching "logs diff on user update".
