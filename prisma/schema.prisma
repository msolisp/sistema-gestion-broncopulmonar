generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════
// ENUMS - Type Safety & FHIR Alignment
// ═══════════════════════════════════════════════════════

enum Sexo {
  M
  F
  OTRO
  NO_ESPECIFICADO
}

enum RolUsuario {
  KINESIOLOGO
  MEDICO
  ENFERMERA
  TECNICO_PARVULARIO
  ADMIN
  RECEPCIONISTA
}

enum TipoAcceso {
  PACIENTE
  STAFF
}

// ═══════════════════════════════════════════════════════
// NEW MODELS - FHIR-Aligned & Certification Ready
// ═══════════════════════════════════════════════════════

// Persona: Demographic data (non-clinical, non-employment)
// Maps to FHIR Patient.demographics
model Persona {
  id String @id @default(cuid())

  // Identificación
  rut             String  @unique
  nombre          String
  apellidoPaterno String
  apellidoMaterno String?

  // Contacto (opcional para adultos mayores, menores, emergencias)
  email     String? @unique
  telefono  String?
  direccion String?
  comuna    String?
  region    String?

  // Demográficos - FHIR aligned
  fechaNacimiento DateTime?
  sexo            Sexo?

  // Relaciones
  fichaClinica   FichaClinica?
  usuarioSistema UsuarioSistema?
  credencial     Credencial?

  // Auditoría (OBLIGATORIO para certificación)
  creadoPor     String
  modificadoPor String?
  creadoEn      DateTime @default(now())
  modificadoEn  DateTime @updatedAt

  // Soft Delete (Retención: 15 años post último contacto)
  activo       Boolean   @default(true)
  eliminadoEn  DateTime?
  eliminadoPor String?

  @@index([rut])
  @@index([nombre, apellidoPaterno])
  @@map("persona")
}

// Credencial: Centralized authentication (separated from clinical/employment)
model Credencial {
  id        String  @id @default(cuid())
  personaId String  @unique
  persona   Persona @relation(fields: [personaId], references: [id], onDelete: Cascade)

  // Autenticación
  passwordHash String
  tipoAcceso   TipoAcceso

  // Control de acceso
  ultimoAcceso        DateTime?
  intentosFallidos    Int       @default(0)
  bloqueadoHasta      DateTime?
  debeCambiarPassword Boolean   @default(false)

  // MFA (futuro)
  mfaHabilitado Boolean        @default(false)
  mfaSecret     String?
  codigosBackup CodigoBackup[] // Emergency backup codes

  // Auditoría
  creadoEn     DateTime @default(now())
  modificadoEn DateTime @updatedAt

  @@index([personaId, tipoAcceso])
  @@map("credencial")
}

// FichaClinica: Clinical data ONLY - Maps to FHIR Patient.clinicalData
model FichaClinica {
  id        String  @id @default(cuid())
  personaId String  @unique
  persona   Persona @relation(fields: [personaId], references: [id], onDelete: Restrict)

  // Identificación clínica
  numeroFicha String @unique

  // Datos clínicos
  prevision            String?
  planSalud            String?
  diagnosticoPrincipal String?
  fechaDiagnostico     DateTime?
  cota                 Float?

  // Relaciones médicas
  citas          Cita[]
  examenes       ExamenMedico[]
  pruebasFuncion PruebaFuncionPulmonar[]
  notificaciones NotificacionMedica[]

  // Auditoría médica (CRÍTICO para certificación)
  creadoPor     String
  modificadoPor String?
  creadoEn      DateTime @default(now())
  modificadoEn  DateTime @updatedAt

  // Soft delete (NO eliminar físicamente - Retención 15 años)
  activo            Boolean   @default(true)
  eliminadoEn       DateTime?
  eliminadoPor      String?
  motivoEliminacion String?

  @@index([numeroFicha])
  @@index([prevision])
  @@map("ficha_clinica")
}

// UsuarioSistema: Employment data ONLY - Maps to FHIR Practitioner
model UsuarioSistema {
  id        String  @id @default(cuid())
  personaId String  @unique
  persona   Persona @relation(fields: [personaId], references: [id], onDelete: Restrict)

  // Identificación profesional
  rol                 RolUsuario
  registroProfesional String?    @unique
  especialidad        String?

  // Control de acceso
  permisos   PermisoUsuario[]
  logsAcceso LogAccesoSistema[]

  // Auditoría laboral
  creadoPor     String
  modificadoPor String?
  creadoEn      DateTime @default(now())
  modificadoEn  DateTime @updatedAt

  // Soft delete
  activo       Boolean   @default(true)
  eliminadoEn  DateTime?
  eliminadoPor String?

  @@index([registroProfesional])
  @@index([rol])
  @@map("usuario_sistema")
}

// Cita: Appointments (renamed from Appointment for consistency)
model Cita {
  id             String       @id @default(cuid())
  fichaClinicaId String
  fichaClinica   FichaClinica @relation(fields: [fichaClinicaId], references: [id], onDelete: Cascade)

  fecha        DateTime
  estado       String   @default("PENDIENTE")
  notas        String?
  creadoEn     DateTime @default(now())
  modificadoEn DateTime @updatedAt

  @@index([fichaClinicaId, fecha])
  @@map("cita")
}

// ExamenMedico: Medical exams with audit trail
model ExamenMedico {
  id             String       @id @default(cuid())
  fichaClinicaId String
  fichaClinica   FichaClinica @relation(fields: [fichaClinicaId], references: [id], onDelete: Restrict)

  // Identificación del examen
  nombreCentro String
  nombreDoctor String
  fechaExamen  DateTime

  // Archivo
  archivoUrl    String
  archivoNombre String?

  // Revisión
  revisado     Boolean  @default(false)
  creadoEn     DateTime @default(now())
  modificadoEn DateTime @updatedAt

  // Origen y auditoría
  origen    String  @default("portal interno")
  subidoPor String?

  @@index([fichaClinicaId, fechaExamen])
  @@map("examen_medico")
}

// NotificacionMedica: Medical notifications
model NotificacionMedica {
  id             String       @id @default(cuid())
  fichaClinicaId String
  fichaClinica   FichaClinica @relation(fields: [fichaClinicaId], references: [id], onDelete: Cascade)

  tipo     String
  titulo   String
  mensaje  String
  examenId String?
  leido    Boolean  @default(false)
  creadoEn DateTime @default(now())

  @@index([leido, creadoEn])
  @@index([fichaClinicaId])
  @@map("notificacion_medica")
}

// PruebaFuncionPulmonar: Pulmonary function tests
model PruebaFuncionPulmonar {
  id             String       @id @default(cuid())
  fichaClinicaId String
  fichaClinica   FichaClinica @relation(fields: [fichaClinicaId], references: [id], onDelete: Cascade)

  fecha          DateTime
  cvfValue       Float?
  cvfPercent     Int?
  vef1Value      Float?
  vef1Percent    Int?
  dlcoPercent    Int?
  walkDistance   Float?
  spo2Rest       Int?
  spo2Final      Int?
  heartRateRest  Int?
  heartRateFinal Int?
  notas          String?
  creadoEn       DateTime @default(now())

  @@index([fichaClinicaId, fecha])
  @@map("prueba_funcion_pulmonar")
}

// PermisoUsuario: Granular permissions (RBAC)
model PermisoUsuario {
  id        String         @id @default(cuid())
  usuarioId String
  usuario   UsuarioSistema @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  recurso String
  accion  String
  activo  Boolean @default(true)

  // Auditoría
  otorgadoPor String
  otorgadoEn  DateTime @default(now())

  @@unique([usuarioId, recurso, accion])
  @@index([usuarioId, activo])
  @@map("permiso_usuario")
}

// LogAccesoSistema: Access logs (immutable, 7-year retention) - Enhanced for MINSAL
model LogAccesoSistema {
  id String @id @default(cuid())

  // Quien accedió
  usuarioId String
  usuario   UsuarioSistema @relation(fields: [usuarioId], references: [id], onDelete: Restrict)

  // A qué accedió
  accion    String
  recurso   String
  recursoId String

  // Contexto
  fecha   DateTime @default(now())
  exitoso Boolean  @default(true)

  // Enhanced audit fields for MINSAL compliance  
  ipAddress     String  @default("unknown") // Client IP address
  userAgent     String? // Browser/client user agent
  accionDetalle String? @db.Text // JSON with additional details
  resultado     String? // SUCCESS, DENIED, ERROR
  sessionId     String? // Session identifier
  duracionMs    Int? // Action duration in milliseconds

  @@index([usuarioId, fecha])
  @@index([recursoId, fecha])
  @@index([ipAddress])
  @@index([resultado])
  @@map("log_acceso_sistema")
}

// CodigoBackup: Emergency backup codes for MFA
model CodigoBackup {
  id           String     @id @default(cuid())
  credencialId String
  credencial   Credencial @relation(fields: [credencialId], references: [id], onDelete: Cascade)
  codigo       String     @unique // Hashed backup code
  usado        Boolean    @default(false)
  usadoEn      DateTime?
  creadoEn     DateTime   @default(now())

  @@index([credencialId])
  @@index([codigo])
  @@map("codigo_backup")
}

// ═══════════════════════════════════════════════════════
// LEGACY MODELS - To be deprecated after migration
// ═══════════════════════════════════════════════════════

/// @deprecated Use Persona + FichaClinica + Credencial instead
model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  password           String
  name               String?
  role               String   @default("KINESIOLOGIST")
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  mustChangePassword Boolean  @default(false)
  rut                String?  @unique
  address            String?
  commune            String?
  region             String?
}

/// @deprecated Use Persona + FichaClinica + Credencial instead
model Patient {
  id             String                  @id @default(cuid())
  phone          String?
  commune        String
  gender         String?
  address        String?
  birthDate      DateTime?
  healthSystem   String?
  diagnosisDate  DateTime?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  active         Boolean                 @default(true)
  email          String                  @unique
  name           String
  password       String
  rut            String                  @unique
  region         String?
  cota           Float?
  appointments   Appointment[]
  exams          MedicalExam[]
  notifications  Notification[]
  pulmonaryTests PulmonaryFunctionTest[]
}

/// @deprecated Use Cita instead
model Appointment {
  id        String   @id @default(cuid())
  patientId String
  date      DateTime
  status    String   @default("PENDING")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

/// @deprecated Use ExamenMedico instead
model MedicalExam {
  id               String   @id @default(cuid())
  patientId        String
  centerName       String
  doctorName       String
  examDate         DateTime
  fileUrl          String
  fileName         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  reviewed         Boolean  @default(false)
  source           String   @default("portal interno")
  uploadedByUserId String?
  patient          Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

/// @deprecated Use NotificacionMedica instead
model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  patientId String
  examId    String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([read, createdAt])
}

/// @deprecated Use PruebaFuncionPulmonar instead
model PulmonaryFunctionTest {
  id             String   @id @default(cuid())
  patientId      String
  date           DateTime
  cvfValue       Float?
  cvfPercent     Int?
  vef1Value      Float?
  vef1Percent    Int?
  dlcoPercent    Int?
  walkDistance   Float?
  spo2Rest       Int?
  spo2Final      Int?
  heartRateRest  Int?
  heartRateFinal Int?
  notes          String?
  createdAt      DateTime @default(now())
  patient        Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

// ═══════════════════════════════════════════════════════
// SYSTEM & REFERENCE DATA
// ═══════════════════════════════════════════════════════

model SystemLog {
  id        String   @id @default(cuid())
  action    String
  details   String?
  userId    String?
  userEmail String?
  ipAddress String?
  createdAt DateTime @default(now())
}

model RolePermission {
  id        String   @id @default(cuid())
  role      String
  action    String
  enabled   Boolean  @default(false)
  updatedAt DateTime @updatedAt

  @@unique([role, action])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model MedicalKnowledge {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  imageUrl  String?
  category  String?
  title     String
  updatedAt DateTime @updatedAt
}

model Comuna {
  id        String   @id @default(cuid())
  nombre    String   @unique
  region    String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Prevision {
  id        String   @id @default(cuid())
  nombre    String   @unique
  tipo      String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DiagnosticoCIE10 {
  id          String   @id @default(cuid())
  codigo      String   @unique
  descripcion String
  categoria   String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Medicamento {
  id              String   @id @default(cuid())
  nombre          String
  principioActivo String?
  presentacion    String?
  laboratorio     String?
  activo          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Insumo {
  id           String   @id @default(cuid())
  nombre       String
  categoria    String?
  unidadMedida String?
  activo       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Feriado {
  id        String   @id @default(cuid())
  nombre    String
  fecha     DateTime
  tipo      String
  region    String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fecha, region])
}
